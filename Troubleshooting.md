### Домашнее задание к занятию  Troubleshooting

###### Задача 1

1. Найти `opid` операций, которые выполняются дольше 3 минут

          db.currentOp(
          {
           "active" : true,
           "secs_running" : { "$gt" : 180 },
         }
        )
   
   
2. Завершить операцию по `opid`
 
       db.killOp(<opid>)
       
1. Настроить профилирование и проанализировать долгие запросы. Можно оптимизировать запросы или настроить индексы
2. Как вариант - настроить максимально возможное время выполнения запросов через `$maxTimeMS.`       
 

##### Задача 2
Похоже что  проблема в методе удаления ключей с истекшим сроком действия. По умолчанию `Redis` запускает 20 `ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP` 10 раз в секунду. То есть алгоритм удаляет 200 ключей в секунду. Если `Redis` блокирует операции записи, значит в базе появилось большое количество ключей, которые истекают в одно время (их количество больше 25% от текущей совокупности ключей с истекшим сроком действия).

##### Задача 3

##### Вероятные причины:

- Сетевые проблемы. Необходимо проверить подключение. Также необходимо выполнить команду `SHOW GLOBAL STATUS LIKE 'Aborted_connects'`. Если его значение увеличивается (оно увеличивается при каждом прерыванни соединения со стороны сервера), то необходимо увеличить параметр `connect_timeout`
- Большой запрос, который не успевает отработать за `net_read_timeout` (30 секунд по умолчанию). Увеличить данный параметр
- Если в ошибке есть `ER_NET_PACKET_TOO_LARGE`, то вероятно проблема в превышении размера сообщения. Необходимо увеличить параметр `max_allowed_packet`

#### Задача 4

`OOM Killer` - процесс, который завершает приложение при нехватки памяти. Полагаю, что на сервере `PostgreSQL` утилизировал всю доступную память, поэтому oom-killer завершил его процесс. Это необходимо, чтобы не обрушилась вся система.

##### Какие есть пути решения:

- Отключить `oom-killer`. Это небезопасно для сервера, поэтому не рекомендуется

- Ограничить доступную для `PostgreSQL` память

- Не запускать на одном сервере с `PostgreSQL` другие приложения, которые могут утилизировать RAM

- Увеличить ресурсы сервера (есть вероятность, что текущих мощностей уже не хватает)
